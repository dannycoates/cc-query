name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Zig
        uses: goto-bus-stop/setup-zig@v2

      - name: Install cargo-zigbuild
        run: cargo install --locked cargo-zigbuild

      - name: Add Rust targets
        run: |
          rustup target add x86_64-unknown-linux-gnu
          rustup target add aarch64-unknown-linux-gnu
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Download DuckDB libs
        env:
          GH_TOKEN: ${{ github.token }}
          DUCKDB_LIBS_VERSION: v1.4.4
        run: |
          chmod +x scripts/download-duckdb-libs.sh
          ./scripts/download-duckdb-libs.sh

      - name: Ensure zlib is available for static linking
        run: |
          sudo apt-get update && sudo apt-get install -y zlib1g-dev
          # Copy system zlib to target dirs that don't already have it
          for target_dir in duckdb-libs/*/; do
            if [ ! -f "$target_dir/libz.a" ]; then
              cp /usr/lib/x86_64-linux-gnu/libz.a "$target_dir" || true
            fi
          done

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # PWD is used by .goreleaser.yml to construct per-target paths
          PWD: ${{ github.workspace }}
