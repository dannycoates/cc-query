# cc-allow Global Configuration Example
# Place at: ~/.config/cc-allow.toml
#
# This provides sensible defaults for common *nix commands and coreutils.
# Project-level configs can add stricter rules on top of this.

version = "2.0"

# ============================================================================
# ALIASES
# ============================================================================
# Define reusable pattern aliases to reduce repetition

[aliases]
project = "path:$PROJECT_ROOT/**"
plugin = "path:$CLAUDE_PLUGIN_ROOT/**"
sensitive-read = ["path:$HOME/.ssh/**", "path:**/*.key", "path:**/*.pem"]
sensitive-write = [
    "path:$HOME/.*",
    "path:/etc/**",
    "path:/usr/**",
    "path:/bin/**",
    "path:/sbin/**",
    "path:/lib/**",
    "path:/lib64/**",
    "path:/var/**",
    "path:/boot/**",
    "path:/root/**",
]

# ============================================================================
# BASH TOOL CONFIGURATION
# ============================================================================

[bash]
default = "ask"                    # defer unmatched commands to Claude Code
dynamic_commands = "ask"           # $VAR or $(cmd) as command names
default_message = "Command not in allow list"
unresolved_commands = "ask"        # "ask" or "deny" for commands not found in PATH

# ============================================================================
# SHELL CONSTRUCTS
# ============================================================================

[bash.constructs]
function_definitions = "deny"      # prevent command shadowing
background = "ask"                 # background jobs need review
subshells = "ask"                  # subshells need review
heredocs = "allow"                 # heredocs are generally safe

# ============================================================================
# ALLOWED COMMANDS
# ============================================================================
# These are generally safe read-only or low-risk commands.
# Note: Dangerous variations (like rm -rf) are blocked by specific rules below.
#
# Command names can use path: prefix to match by resolved filesystem path:
#   "path:$PROJECT_ROOT/bin/*"      - allow project-local binaries
#   "path:$CLAUDE_PLUGIN_ROOT/**"   - allow plugin/skill-local binaries
#   "path:/usr/bin/git"             - allow git only from /usr/bin

[bash.allow]
commands = [
    # -------------------------------------------------------------------------
    # Plugin/Skill Binaries
    # -------------------------------------------------------------------------
    "path:$CLAUDE_PLUGIN_ROOT/**",  # allow binaries from loaded skill/plugin
    "path:$HOME/**/cc-query",

    # -------------------------------------------------------------------------
    # File & Directory Navigation
    # -------------------------------------------------------------------------
    "ls", "dir", "vdir",           # list directory contents
    "pwd",                          # print working directory
    "tree",                         # directory tree view
    "file",                         # determine file type
    "stat",                         # file/filesystem status
    "basename", "dirname",          # path component extraction
    "realpath", "readlink",         # resolve paths and symlinks

    # -------------------------------------------------------------------------
    # File Viewing & Reading
    # -------------------------------------------------------------------------
    "cat", "tac",                   # concatenate/reverse files
    "head", "tail",                 # first/last lines
    "less", "more",                 # pagers
    "nl",                           # number lines
    "od", "hexdump", "xxd",         # binary/hex viewers

    # -------------------------------------------------------------------------
    # Text Processing & Transformation
    # -------------------------------------------------------------------------
    "grep", "egrep", "fgrep",       # pattern matching
    "sed", "awk", "gawk",           # stream editing (output only, not in-place)
    "cut", "paste", "join",         # column operations
    "sort", "uniq", "shuf",         # line ordering/filtering
    "tr", "rev",                    # character translation
    "expand", "unexpand",           # tab/space conversion
    "fold", "fmt",                  # line wrapping
    "column",                       # columnate output
    "pr",                           # paginate for printing
    "wc",                           # word/line/byte count
    "comm", "diff", "cmp", "colordiff", "delta",  # comparison
    "iconv",                        # character encoding conversion
    "strings",                      # extract printable strings

    # -------------------------------------------------------------------------
    # Searching & Finding
    # -------------------------------------------------------------------------
    "find",                         # find files
    "fd",                           # modern find alternative
    "locate", "mlocate", "plocate", # locate files in database
    "which", "whereis", "type",     # locate commands
    "xargs",                        # build commands from stdin
    "rg", "ripgrep",                # ripgrep
    "ag",                           # silver searcher
    "fzf",                          # fuzzy finder

    # -------------------------------------------------------------------------
    # File Operations (Non-Destructive)
    # -------------------------------------------------------------------------
    "cp",                           # copy files
    "mv",                           # move/rename files
    "touch",                        # create/update timestamps
    "mkdir",                        # create directories
    "ln",                           # create links
    "install",                      # copy and set attributes

    # -------------------------------------------------------------------------
    # Archive & Compression
    # -------------------------------------------------------------------------
    "tar",                          # archive files
    "gzip", "gunzip", "zcat",       # gzip compression
    "bzip2", "bunzip2", "bzcat",    # bzip2 compression
    "xz", "unxz", "xzcat",          # xz compression
    "zstd", "unzstd", "zstdcat",    # zstd compression
    "zip", "unzip",                 # zip archives
    "7z", "7za", "7zr",             # 7-zip
    "rar", "unrar",                 # rar archives

    # -------------------------------------------------------------------------
    # Printing & Output
    # -------------------------------------------------------------------------
    "echo", "printf",               # print text
    "yes",                          # repeated output
    "seq",                          # number sequences
    "tee",                          # pipe to file and stdout

    # -------------------------------------------------------------------------
    # Date, Time & Calculation
    # -------------------------------------------------------------------------
    "date",                         # date/time display
    "cal", "ncal",                  # calendar
    "time",                         # time command execution
    "bc", "dc",                     # calculators
    "expr",                         # expression evaluation
    "factor",                       # factorize numbers

    # -------------------------------------------------------------------------
    # User & System Info (Read-Only)
    # -------------------------------------------------------------------------
    "whoami",                       # current user
    "id",                           # user/group IDs
    "groups",                       # group memberships
    "who", "w",                     # logged in users
    "users",                        # list users
    "last", "lastlog",              # login history
    "finger",                       # user info
    "uname",                        # system info
    "hostname",                     # system hostname
    "hostnamectl",                  # hostname info (read-only)
    "uptime",                       # system uptime
    "arch",                         # machine architecture
    "nproc",                        # number of processors
    "lscpu",                        # CPU info
    "lsmem",                        # memory info
    "free",                         # memory usage
    "df",                           # disk space
    "du",                           # directory sizes
    "lsblk",                        # block devices
    "lsusb",                        # USB devices
    "lspci",                        # PCI devices
    "lsof",                         # open files
    "dmesg",                        # kernel messages

    # -------------------------------------------------------------------------
    # Process Inspection (Read-Only)
    # -------------------------------------------------------------------------
    "ps",                           # process status
    "top",                          # process monitors
    "pgrep", "pidof",               # find process IDs
    "pstree",                       # process tree
    "jobs",                         # job control (built-in)
    "nice", "renice",               # priority (viewing)

    # -------------------------------------------------------------------------
    # Network Inspection (Read-Only)
    # -------------------------------------------------------------------------
    "ping", "ping6",                # network connectivity
    "traceroute", "tracepath",      # route tracing
    "mtr",                          # network diagnostic
    "dig", "nslookup", "host",      # DNS lookup
    "whois",                        # domain info
    "ip",                           # network config (read-only)
    "ifconfig",                     # legacy network config
    "ss", "netstat",                # socket/network stats
    "nc", "netcat",                 # network utility
    "nmap",                         # network scanner
    "tcpdump",                      # packet capture

    # -------------------------------------------------------------------------
    # Shell Builtins & Utilities
    # -------------------------------------------------------------------------
    "test", "[", "[[",              # conditionals
    "true", "false",                # exit status
    "sleep",                        # delay
    "env", "printenv",              # environment

    # -------------------------------------------------------------------------
    # Version Control
    # -------------------------------------------------------------------------
    "git",                          # git
    "gh",                           # GitHub CLI
    "hg",                           # mercurial
    "svn",                          # subversion
    "fossil",                       # fossil

    # -------------------------------------------------------------------------
    # Misc Utilities
    # -------------------------------------------------------------------------
    "man", "info", "help",          # documentation
    "apropos", "whatis",            # command lookup
    "tldr",                         # simplified man pages
    "watch",                        # repeated execution
    "timeout",                      # run with time limit
    "strace", "ltrace",             # syscall/library tracing
    "md5sum", "sha1sum", "sha256sum", "sha512sum",  # checksums
    "base64",                       # base64 encoding
    "nix", "nix-env", "nix-shell",  # Nix
    "jq",                           # JSON processor
]

# ============================================================================
# DENIED COMMANDS
# ============================================================================
# These commands are categorically dangerous and should never run automatically.

[bash.deny]
commands = [
    # Privilege escalation
    "sudo", "su", "doas", "pkexec",
    # Disk/filesystem operations
    "dd", "mkfs", "fdisk", "parted", "gdisk", "cfdisk", "sfdisk",
    "mkswap", "swapon", "swapoff",
    "mount", "umount",
    "losetup",
    "lvm", "pvcreate", "vgcreate", "lvcreate",
    # System control
    "shutdown", "reboot", "halt", "poweroff", "init", "telinit",
    # User/group management
    "useradd", "userdel", "usermod",
    "groupadd", "groupdel", "groupmod",
    "passwd", "chpasswd",
    "chsh", "chfn",
    # Mass process control
    "killall", "pkill",
    # Dangerous network
    "iptables", "ip6tables", "nft", "firewall-cmd",
    "route",                        # modify routing
    # System modification
    "sysctl",
    "modprobe", "insmod", "rmmod",  # kernel modules
    "update-grub", "grub-install",
]
message = "{{.Command}} blocked - dangerous system command"

# ============================================================================
# REDIRECTS
# ============================================================================
# Redirects respect file rules - output redirects (>, >>) check Write rules,
# input redirects (<) check Read rules.

[bash.redirects]
respect_file_rules = true

[[bash.redirects.allow]]
paths = ["/dev/null"]

# ============================================================================
# SPECIFIC RULES
# ============================================================================
# Fine-grained control for commands that are generally safe but have
# dangerous modes.

[[bash.allow.node]]
args.any = ["alias:project"]

[[bash.allow.npm.run]]

# --- systemctl: Allow status checks ---
[[bash.allow.systemctl.status]]

# --- rm: Block recursive deletion ---
[[bash.deny.rm]]
message = "{{.ArgsStr}} - recursive deletion not allowed"
args.any = ["flags:r", "--recursive"]

# --- rm: Allow non-recursive rm ---
[[bash.allow.rm]]

# --- rmdir: Allow (only removes empty directories) ---
[[bash.allow.rmdir]]

# --- chmod: Block making files executable ---
[[bash.deny.chmod]]
message = "{{.ArgsStr}} - making files executable requires review"
args.any = ["re:\\+x", "re:[0-7][1357][0-7]", "re:[0-7][0-7][1357]"]

# --- chmod: Allow other chmod operations ---
[[bash.allow.chmod]]

# --- chown/chgrp: Always deny (ownership changes are sensitive) ---
[[bash.deny.chown]]
message = "{{.ArgsStr}} - ownership changes not allowed"

[[bash.deny.chgrp]]
message = "{{.ArgsStr}} - group changes not allowed"

# --- git: Block force push ---
[[bash.deny.git.push]]
message = "{{.ArgsStr}} - force push not allowed"
args.any = ["--force", "flags:f", "--force-with-lease"]

# --- git: Block hard reset ---
[[bash.deny.git.reset]]
message = "{{.ArgsStr}} - hard reset may lose work"
args.contains = ["--hard"]

# --- git: Block clean -f (force delete untracked files) ---
[[bash.deny.git.clean]]
message = "{{.ArgsStr}} - git clean requires review"
args.any = ["flags:f", "--force"]

# --- sed/awk: Block in-place editing ---
[[bash.deny.sed]]
message = "{{.ArgsStr}} - in-place editing not allowed, use Edit tool"
args.any = ["flags:i", "--in-place"]

[[bash.deny.awk]]
message = "{{.ArgsStr}} - in-place editing not allowed, use Edit tool"
args.any = ["flags:i"]

# --- curl/wget: Block piping to shell ---
[[bash.deny.bash]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} - piping to shell not allowed"
pipe.from = ["curl", "wget", "http"]

[[bash.deny.sh]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} - piping to shell not allowed"
pipe.from = ["curl", "wget", "http"]

[[bash.deny.zsh]]
message = "{{.Command}} receiving from {{index .PipesFrom 0}} - piping to shell not allowed"
pipe.from = ["curl", "wget", "http"]

# --- docker/podman: Block privileged containers ---
[[bash.deny.docker]]
message = "{{.ArgsStr}} - privileged containers not allowed"
args.any = ["--privileged"]

[[bash.deny.podman]]
message = "{{.ArgsStr}} - privileged containers not allowed"
args.any = ["--privileged"]

# --- ssh: Block with -o options that could be dangerous ---
[[bash.deny.ssh]]
message = "{{.ArgsStr}} - ssh with custom options requires review"
args.any = ["flags:o"]

# ============================================================================
# FILE TOOL PERMISSIONS (Read, Edit, Write)
# ============================================================================
# Control Claude Code's Read, Edit, and Write file tools.
# Also controls bash commands that access files and redirects.
# Evaluation order: deny -> allow -> default (deny always wins)

[read]
default = "ask"  # defer to Claude Code when no rules match

[read.allow]
paths = ["alias:project", "alias:plugin", "path:/tmp/**", "path:$HOME/.local/log/cc-proxy/cc-proxy.log"]

[read.deny]
paths = ["alias:sensitive-read"]
message = "Cannot read {{.FileName}} - sensitive file"

[edit]
default = "ask"

[edit.allow]
paths = ["alias:project"]

[edit.deny]
paths = ["path:$HOME/.*"]
message = "Cannot edit {{.FileName}} - sensitive file"

# Also applies to output redirects (>, >>) when bash.redirects.respect_file_rules = true
[write]
default = "ask"

[write.allow]
paths = ["alias:project", "path:/tmp/**"]

[write.deny]
paths = ["alias:sensitive-write"]
message = "Cannot write to {{.FilePath}} - system directory"
